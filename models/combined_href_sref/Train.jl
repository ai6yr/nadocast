import Dates

push!(LOAD_PATH, (@__DIR__) * "/../shared")
import TrainingShared
import LogisticRegression
using Metrics

push!(LOAD_PATH, @__DIR__)
import CombinedHREFSREF

push!(LOAD_PATH, (@__DIR__) * "/../../lib")
import Forecasts
import Inventories


(_, validation_forecasts, _) = TrainingShared.forecasts_train_validation_test(CombinedHREFSREF.forecasts_href_newer(); just_hours_near_storm_events = false);

# We don't have storm events past this time.
cutoff = Dates.DateTime(2022, 6, 1, 12)
validation_forecasts = filter(forecast -> Forecasts.valid_utc_datetime(forecast) < cutoff, validation_forecasts);

length(validation_forecasts) # 17918


# const ε = 1e-15 # Smallest Float64 power of 10 you can add to 1.0 and not round off to 1.0
const ε = 1f-7 # Smallest Float32 power of 10 you can add to 1.0 and not round off to 1.0
logloss(y, ŷ) = -y*log(ŷ + ε) - (1.0f0 - y)*log(1.0f0 - ŷ + ε)

σ(x) = 1.0f0 / (1.0f0 + exp(-x))

logit(p) = log(p / (one(p) - p))


X, Ys, weights =
  TrainingShared.get_data_labels_weights(
    validation_forecasts;
    event_name_to_labeler = TrainingShared.event_name_to_labeler,
    save_dir = "validation_forecasts_href_newer"
  );

event_types_count = length(CombinedHREFSREF.models)

# Confirm that HREF models are better
function test_predictive_power(forecasts, X, Ys, weights)
  inventory = Forecasts.inventory(forecasts[1])

  # Feature order is all HREF severe probs then all SREF severe probs
  for feature_i in 1:length(inventory)
    prediction_i = 1 + (feature_i - 1) % event_types_count
    (event_name, _) = CombinedHREFSREF.models[prediction_i]
    y = Ys[event_name]
    x = @view X[:,feature_i]
    au_pr_curve = Metrics.area_under_pr_curve(x, y, weights)
    println("$event_name ($(sum(y))) feature $feature_i $(Inventories.inventory_line_description(inventory[feature_i]))\tAU-PR-curve: $au_pr_curve")
  end
end
test_predictive_power(validation_forecasts, X, Ys, weights)

# tornado (66484.0)        feature 1 TORPROB:calculated:hour   fcst:calculated_prob:blurred AU-PR-curve: 0.04096050922959824
# wind (524123.0)          feature 2 WINDPROB:calculated:hour  fcst:calculated_prob:blurred AU-PR-curve: 0.12359914323642289
# wind_adj (158758.72)     feature 3 WINDPROB:calculated:hour  fcst:calculated_prob:blurred AU-PR-curve: 0.06579056292038551
# hail (237780.0)          feature 4 HAILPROB:calculated:hour  fcst:calculated_prob:blurred AU-PR-curve: 0.07644116022386543
# sig_tornado (9355.0)     feature 5 STORPROB:calculated:hour  fcst:calculated_prob:blurred AU-PR-curve: 0.02930912296157666
# sig_wind (51376.0)       feature 6 SWINDPRO:calculated:hour  fcst:calculated_prob:blurred AU-PR-curve: 0.016991991337000804
# sig_wind_adj (18092.895) feature 7 SWINDPRO:calculated:hour  fcst:calculated_prob:blurred AU-PR-curve: 0.013898139435587277
# sig_hail (27885.0)       feature 8 SHAILPRO:calculated:hour  fcst:calculated_prob:blurred AU-PR-curve: 0.018954516980244043
# tornado (66484.0)        feature 9 TORPROB:calculated:hour   fcst:calculated_prob:blurred AU-PR-curve: 0.023198579852888944
# wind (524123.0)          feature 10 WINDPROB:calculated:hour fcst:calculated_prob:blurred AU-PR-curve: 0.09053563878797445
# wind_adj (158758.72)     feature 11 WINDPROB:calculated:hour fcst:calculated_prob:blurred AU-PR-curve: 0.04608418454423105
# hail (237780.0)          feature 12 HAILPROB:calculated:hour fcst:calculated_prob:blurred AU-PR-curve: 0.05272323284307826
# sig_tornado (9355.0)     feature 13 STORPROB:calculated:hour fcst:calculated_prob:blurred AU-PR-curve: 0.013200836534184881
# sig_wind (51376.0)       feature 14 SWINDPRO:calculated:hour fcst:calculated_prob:blurred AU-PR-curve: 0.011702071814021137
# sig_wind_adj (18092.895) feature 15 SWINDPRO:calculated:hour fcst:calculated_prob:blurred AU-PR-curve: 0.015107926205925437
# sig_hail (27885.0)       feature 16 SHAILPRO:calculated:hour fcst:calculated_prob:blurred AU-PR-curve: 0.013757293287310518

event_names = map(m -> m[1], CombinedHREFSREF.models)

# HREF
Metrics.reliability_curves_midpoints(20, (@view X[:, 1:event_types_count]), Ys, event_names, weights, event_names)
# ŷ_tornado,y_tornado,ŷ_wind,y_wind,ŷ_wind_adj,y_wind_adj,ŷ_hail,y_hail,ŷ_sig_tornado,y_sig_tornado,ŷ_sig_wind,y_sig_wind,ŷ_sig_wind_adj,y_sig_wind_adj,ŷ_sig_hail,y_sig_hail,
# 8.164628e-6,6.163226e-6,6.450356e-5,4.8636637e-5,2.1606318e-5,1.4458051e-5,2.3512686e-5,2.1909607e-5,9.4464724e-7,8.59296e-7,5.834991e-6,4.7302065e-6,2.9764913e-6,1.6225912e-6,3.0398992e-6,2.5212494e-6,
# 0.00033269852,0.00034430335,0.002926606,0.002616727,0.00091651105,0.00080696045,0.001133057,0.0012898906,9.3095725e-5,0.00016721348,0.00023047313,0.0002603761,0.00016480683,0.000111033485,0.00024387368,0.0002871413,
# 0.0008027713,0.0008900477,0.0058789696,0.0052562417,0.0018642651,0.0017239021,0.0022890246,0.0025956624,0.00031756135,0.0002402809,0.00048635574,0.00057269353,0.00035786064,0.00026669403,0.0005033885,0.00063064764,
# 0.0014166418,0.0016171455,0.009209167,0.0089191105,0.0030497392,0.0026392487,0.003654954,0.004053292,0.00084582495,0.000585215,0.0008170574,0.00084025116,0.0005824021,0.0004906666,0.00081995706,0.0009087629,
# 0.002193577,0.002445471,0.012814649,0.012816507,0.0045352313,0.004193331,0.0052419254,0.0059331316,0.0015803324,0.0011255215,0.0012434331,0.0013130329,0.0008298214,0.0007935089,0.0011987708,0.0015101779,
# 0.003183389,0.0033399286,0.016754173,0.017549947,0.0062392657,0.0062161325,0.007050796,0.007920622,0.0023971726,0.0022536207,0.001757026,0.0017788336,0.0011142077,0.001081854,0.0016202816,0.001926309,
# 0.00444828,0.004469875,0.021039534,0.022903034,0.008181013,0.008634625,0.009170421,0.009995553,0.0032263417,0.0031216242,0.0023925584,0.0023636306,0.0014112742,0.001941386,0.0021339827,0.0024321778,
# 0.006055993,0.0057290513,0.025847428,0.027750578,0.01038729,0.011374024,0.011712587,0.012370041,0.004293295,0.0034534943,0.0031507846,0.0032302868,0.0017077744,0.002302532,0.0027286317,0.0032760934,
# 0.008073524,0.007400544,0.031298485,0.034388445,0.012915396,0.014590427,0.014698047,0.015816623,0.0056711067,0.0050141425,0.0039570676,0.0048672594,0.0020358872,0.0031749513,0.003417076,0.003982201,
# 0.010492963,0.009872455,0.037333325,0.042908683,0.015796816,0.018864674,0.018119203,0.020109985,0.0071188197,0.00836721,0.004760585,0.0065020886,0.002368889,0.0040769037,0.004248973,0.0048223175,
# 0.0132094985,0.013675257,0.044040635,0.0508886,0.019046886,0.023783932,0.022008281,0.025311766,0.008588486,0.011103797,0.0056230407,0.00792243,0.0027190174,0.005073691,0.0051981057,0.0064925943,
# 0.016168548,0.017542697,0.051772363,0.059497483,0.022831632,0.028687911,0.026519833,0.030542603,0.010297981,0.013405869,0.0065888236,0.009559604,0.0031285253,0.005546495,0.0062942454,0.0074153417,
# 0.019536449,0.02101645,0.060745705,0.07097736,0.02732946,0.035050936,0.03187675,0.037197586,0.012098605,0.020686645,0.007700058,0.010923978,0.0036038742,0.007812651,0.007690624,0.008434045,
# 0.023537437,0.025225533,0.07123934,0.08480707,0.032729868,0.04218715,0.03851674,0.042770512,0.013843638,0.02735215,0.009013975,0.013125832,0.004079253,0.010825413,0.009518471,0.009970922,
# 0.028605869,0.0276605,0.083724804,0.09981701,0.039467815,0.050983164,0.04695361,0.052434012,0.015716076,0.031288695,0.010614215,0.014487287,0.0045488677,0.014838316,0.011786948,0.013645719,
# 0.035652526,0.030922355,0.09898472,0.11843273,0.047994792,0.06367735,0.05789859,0.062351387,0.01798865,0.032921184,0.012704443,0.016487831,0.005044186,0.018137157,0.014750719,0.015345545,
# 0.045232963,0.041790858,0.118661314,0.13875955,0.058628395,0.08193028,0.072824225,0.07835475,0.020901099,0.034428153,0.015538068,0.01958908,0.0056669503,0.017977126,0.019165467,0.01890046,
# 0.05728127,0.06484392,0.14646953,0.16720249,0.07256092,0.10726238,0.09409711,0.10212095,0.025259335,0.037691377,0.019572774,0.025348127,0.00655726,0.021124713,0.02570938,0.027133022,
# 0.07339878,0.09034593,0.1930923,0.21463351,0.09407443,0.12840545,0.12819867,0.13655372,0.033014823,0.052568182,0.026613208,0.03260398,0.007883914,0.029166836,0.03561054,0.03981577,
# 0.11045569,0.1257686,0.3087201,0.32327017,0.15189713,0.17134498,0.20552848,0.23499228,0.050925303,0.09183111,0.054396838,0.04256961,0.011422678,0.032533046,0.061929654,0.055654805,

# SREF
Metrics.reliability_curves_midpoints(20, (@view X[:, event_types_count+1:2*event_types_count]), Ys, event_names, weights, event_names)
# ŷ_tornado,y_tornado,ŷ_wind,y_wind,ŷ_wind_adj,y_wind_adj,ŷ_hail,y_hail,ŷ_sig_tornado,y_sig_tornado,ŷ_sig_wind,y_sig_wind,ŷ_sig_wind_adj,y_sig_wind_adj,ŷ_sig_hail,y_sig_hail,
# 7.1924132e-6,6.270503e-6,6.7982284e-5,4.965265e-5,2.1781465e-5,1.4842099e-5,2.807481e-5,2.2290456e-5,1.2111186e-6,8.66985e-7,6.6083844e-6,4.875723e-6,3.4986524e-6,1.6700808e-6,5.2892888e-6,2.5378285e-6,
# 0.00022839865,0.00026526384,0.0020804321,0.0020389268,0.00056688563,0.0005346318,0.0008631381,0.00100264,5.314237e-5,0.00011042781,0.0001445597,0.00017905401,7.9292644e-5,5.819187e-5,0.000209992,0.00028914402,
# 0.0005902737,0.0005181919,0.003885862,0.0038709922,0.0011572688,0.0010182719,0.0016522515,0.001991237,0.00019721469,0.00012466466,0.0002943945,0.00030909062,0.00018562973,0.00011260096,0.00035701162,0.000464357,
# 0.0011139796,0.0010527426,0.0058908476,0.006181849,0.0019013657,0.0018314507,0.0025831985,0.0029089164,0.0006089714,0.00046403342,0.00051047007,0.0004628335,0.00033255864,0.00030351308,0.00054048584,0.00070144096,
# 0.0016777521,0.0018346396,0.008048248,0.008773365,0.0027313598,0.0028153097,0.0036922325,0.0041067544,0.0011069147,0.0008799259,0.000796809,0.00071044953,0.0004747488,0.00052334316,0.00075387897,0.0010105585,
# 0.0022769198,0.0025699148,0.010404138,0.011536421,0.0036580986,0.0039796736,0.0049666283,0.005512126,0.0017770109,0.0012217369,0.0011209394,0.0011513078,0.00063062186,0.0007673565,0.0010118091,0.0012193378,
# 0.0029956999,0.0031285863,0.013009893,0.014733133,0.0047510914,0.004848507,0.0064172,0.007173077,0.0025816776,0.002280781,0.0014691014,0.0015469961,0.00080707914,0.0010396839,0.0013434018,0.0014935927,
# 0.0038876054,0.0039682044,0.015913416,0.018165914,0.006066086,0.0064074295,0.008065357,0.009021778,0.0033171473,0.0041353586,0.0018545584,0.0021005394,0.0009950328,0.0015465291,0.0017442493,0.0019651398,
# 0.004958349,0.0050635315,0.01920523,0.021870503,0.007569113,0.00841772,0.009972021,0.0109393,0.003995186,0.0052818023,0.002271386,0.0027133238,0.0011955914,0.0018442982,0.002234421,0.0023168188,
# 0.0062143607,0.006596126,0.022878135,0.027261952,0.009309332,0.010441317,0.012174774,0.013794316,0.0046899975,0.007489453,0.0027313794,0.0033823797,0.0014599115,0.0018398243,0.0028805335,0.0027357126,
# 0.0076573105,0.008321786,0.026897741,0.033340253,0.011378633,0.012932323,0.014731696,0.016278742,0.005402801,0.00862522,0.0032613468,0.0039689527,0.0018532391,0.0018977803,0.003697005,0.003614636,
# 0.009316239,0.010558625,0.03148516,0.038047466,0.013799019,0.016801802,0.01777682,0.019671667,0.0061997054,0.010225562,0.0038874117,0.004872045,0.0024219786,0.0024413264,0.004614956,0.005205909,
# 0.011247396,0.012638017,0.03689597,0.044772714,0.016611036,0.021086898,0.021348143,0.024042405,0.007091312,0.011661715,0.0046630288,0.005390823,0.0030865727,0.0041943635,0.0056796703,0.0061121173,
# 0.01366939,0.014759209,0.04343449,0.050717745,0.019976752,0.026122909,0.02546685,0.030329475,0.00831713,0.009791239,0.0056266226,0.0070519825,0.003792796,0.0059153503,0.0070337364,0.0077158436,
# 0.016798226,0.018203905,0.051607665,0.06113483,0.024019541,0.033072677,0.030229084,0.03834675,0.010104809,0.01065973,0.006794513,0.008747246,0.004596911,0.009153748,0.008703216,0.010490158,
# 0.02106483,0.020199664,0.061823696,0.076017044,0.029063607,0.039142672,0.036085125,0.04638827,0.012247334,0.014206114,0.008313239,0.010963389,0.005531025,0.012035369,0.010859886,0.012641245,
# 0.027112437,0.025325282,0.074992284,0.093311645,0.035547104,0.051867433,0.044083208,0.05468837,0.0146354195,0.017703919,0.010192665,0.015947085,0.006639563,0.020965248,0.013900564,0.016264712,
# 0.035250966,0.0358414,0.09351704,0.11624477,0.04428743,0.06475845,0.056285832,0.06619275,0.018012377,0.018114656,0.012570134,0.019814607,0.007908135,0.02878248,0.01833389,0.021035947,
# 0.04787476,0.040797696,0.124058425,0.14797044,0.05805394,0.08754071,0.07750849,0.08919755,0.02413702,0.019669963,0.0164774,0.023458967,0.009984147,0.031258844,0.025885476,0.02815746,
# 0.082483724,0.06307451,0.20953962,0.26327413,0.091586,0.13403077,0.12678906,0.15671456,0.04172467,0.03205325,0.029994123,0.031777084,0.017439594,0.037109144,0.048040148,0.040436957,

# 3. bin HREF predictions into 6 bins of equal weight of positive labels
# (we will combine adjacent pairs of bins into 5 pairwise overlapping bins)

const bin_count = 6

function find_ŷ_bin_splits(event_name, prediction_i, X, Ys, weights)
  y = Ys[event_name]

  total_positive_weight = sum(Metrics.parallel_iterate(is -> sum(Float64.(view(y, is) .* view(weights, is))), length(y)))
  per_bin_pos_weight = total_positive_weight / bin_count

  ŷ              = @view X[:,prediction_i]; # HREF prediction for event_name
  sort_perm      = Metrics.parallel_sort_perm(ŷ);
  y_sorted       = Metrics.parallel_apply_sort_perm(y, sort_perm);
  ŷ_sorted       = Metrics.parallel_apply_sort_perm(ŷ, sort_perm);
  weights_sorted = Metrics.parallel_apply_sort_perm(weights, sort_perm);

  bins_Σŷ      = zeros(Float64, bin_count)
  bins_Σy      = zeros(Float64, bin_count)
  bins_Σweight = zeros(Float64, bin_count)
  bins_max     = ones(Float32, bin_count)

  bin_i = 1
  for i in 1:length(y_sorted)
    if ŷ_sorted[i] > bins_max[bin_i]
      bin_i += 1
    end

    bins_Σŷ[bin_i]      += Float64(ŷ_sorted[i] * weights_sorted[i])
    bins_Σy[bin_i]      += Float64(y_sorted[i] * weights_sorted[i])
    bins_Σweight[bin_i] += Float64(weights_sorted[i])

    if bins_Σy[bin_i] >= per_bin_pos_weight
      bins_max[bin_i] = ŷ_sorted[i]
    end
  end

  println("event_name\tmean_y\tmean_ŷ\tΣweight\tbin_max")
  for bin_i in 1:bin_count
    Σŷ      = bins_Σŷ[bin_i]
    Σy      = bins_Σy[bin_i]
    Σweight = bins_Σweight[bin_i]

    mean_ŷ = Σŷ / Σweight
    mean_y = Σy / Σweight

    println("$event_name\t$mean_y\t$mean_ŷ\t$Σweight\t$(bins_max[bin_i])")
  end

  bins_max
end

event_to_bins = Dict{String,Vector{Float32}}()
for prediction_i in 1:event_types_count
  (event_name, _) = CombinedHREFSREF.models[prediction_i]

  event_to_bins[event_name] = find_ŷ_bin_splits(event_name, prediction_i, X, Ys, weights)
end

# event_name   mean_y                 mean_ŷ                Σweight              bin_max
# tornado      2.0017512048824645e-5  2.082888175135988e-5  5.2064060230394334e8 0.0013122079
# tornado      0.002655889902000432   0.002478021926246398  3.9244070574436784e6 0.004710326
# tornado      0.0069640493880342375  0.007407600221261315  1.4966173550154567e6 0.011888903
# tornado      0.017362635745529827   0.016314321153062895  600276.2435635328    0.022864908
# tornado      0.02993764406144195    0.032014090804743975  348149.42763745785   0.04753879
# tornado      0.08124910991229588    0.07064408763579479   128235.19191151857   1.0
# event_name   mean_y                 mean_ŷ                Σweight              bin_max
# wind         0.00015741266281200494 0.0001847099208734292 5.164470169485555e8  0.008744916
# wind         0.014206964919374733   0.013853129679784285  5.722189787199557e6  0.021842286
# wind         0.032677585289046206   0.02959411232914133   2.487775991825223e6  0.04064058
# wind         0.0610121840626526     0.05248833196099973   1.3324318704804182e6 0.06938802
# wind         0.10708215059052975    0.0902320184595865    759185.4683158398    0.122678265
# wind         0.2086090465186428     0.18870530573215794   389687.51313841343   1.0
# event_name   mean_y                 mean_ŷ                Σweight              bin_max
# wind_adj     4.6861304088148505e-5  5.7563253031589765e-5 5.1869171649894786e8 0.0028606635
# wind_adj     0.004667626540476744   0.00489083305847296   5.2076608349071145e6 0.008563636
# wind_adj     0.013630166347820426   0.012057438354943648  1.7833216788041592e6 0.017410113
# wind_adj     0.029274485125305144   0.023154653615100468  830326.4349123836    0.031802237
# wind_adj     0.056361043895736714   0.04275826682844031   431268.7670508623    0.060865648
# wind_adj     0.12528409842259042    0.0949236436978124    193993.36489260197   1.0
# event_name   mean_y                 mean_ŷ                Σweight              bin_max
# hail         7.107382862383238e-5   6.692442480027312e-5  5.168657223346699e8  0.003458654
# hail         0.006457659294796132   0.0057813912997365675 5.688788030076444e6  0.009600723
# hail         0.014870803766749464   0.01374327077317342   2.470369201535642e6  0.020057917
# hail         0.031030847719972318   0.026941203482532337  1.1838481899712682e6 0.037324984
# hail         0.05633563361289792    0.05160697245250427   652090.3467494845    0.076065265
# hail         0.1323882140579507     0.12057726119107835   277469.4765122533    1.0
# event_name   mean_y                 mean_ŷ                Σweight              bin_max
# sig_tornado  2.837780059547531e-6   2.958048051348655e-6  5.255118766364023e8  0.0007784463
# sig_tornado  0.0013153812203207443  0.001625880945018886  1.1339622947739959e6 0.0033980992
# sig_tornado  0.004742355433771681   0.0050626061843344035 314396.9325340986    0.007858597
# sig_tornado  0.014811241988098994   0.010144010653834806  100693.46283829212   0.013500211
# sig_tornado  0.03097861945639863    0.01684425238698523   48140.36363977194    0.021512743
# sig_tornado  0.05095276702824725    0.03128486659398223   29217.889326512814   1.0
# event_name   mean_y                 mean_ŷ                Σweight              bin_max
# sig_wind     1.5325299167499523e-5  1.5086300260890803e-5 5.180116382436528e8  0.00076082407
# sig_wind     0.0014118681391051162  0.0013829152656214556 5.622756191015422e6  0.0025200176
# sig_wind     0.004175745303523315   0.003585880442542822  1.9010839804090858e6 0.0051898635
# sig_wind     0.009559409602331962   0.006678366386970533  830492.9002404213    0.008781022
# sig_wind     0.015464049811301612   0.011620243492001886  513391.43561410904   0.016167704
# sig_wind     0.030648287561612413   0.028665423763122     258924.8285831213    1.0
# event_name   mean_y                 mean_ŷ                Σweight              bin_max
# sig_wind_adj 5.286534758688006e-6   8.135203866678671e-6  5.2239671219077384e8 0.0005631988
# sig_wind_adj 0.0009064378093370669  0.0008920361052785085 3.046676583100617e6  0.0014582027
# sig_wind_adj 0.0028822160533730147  0.0019082603474613292 958203.8290531039    0.00254442
# sig_wind_adj 0.006194209307918673   0.0031377993361207126 445882.5478153229    0.0040013813
# sig_wind_adj 0.01517405535053632    0.004729783573926283  182026.16273784637   0.0057724603
# sig_wind_adj 0.02537620484000769    0.007939886255773203  108786.26603424549   1.0
# event_name   mean_y                 mean_ŷ                Σweight              bin_max
# sig_hail     8.286829228855413e-6   7.859713907548184e-6  5.221983799890184e8  0.0007729447
# sig_hail     0.0015600304941201866  0.0013179577646831022 2.7740064467158914e6 0.0022382603
# sig_hail     0.003751650318916818   0.00322102967581788   1.153474297762096e6  0.0047318107
# sig_hail     0.007472737305743317   0.00650323545254852   579104.410691917     0.009228747
# sig_hail     0.014066989688945986   0.013087991077025648  307668.43133723736   0.020026933
# sig_hail     0.034422544845844824   0.034143674029227834  125654.00398945808   1.0

println("href_newer_event_to_bins = $event_to_bins")
# href_newer_event_to_bins = Dict{String, Vector{Float32}}("sig_wind" => [0.00076082407, 0.0025200176, 0.0051898635, 0.008781022, 0.016167704, 1.0], "sig_hail" => [0.0007729447, 0.0022382603, 0.0047318107, 0.009228747, 0.020026933, 1.0], "hail" => [0.003458654, 0.009600723, 0.020057917, 0.037324984, 0.076065265, 1.0], "sig_wind_adj" => [0.0005631988, 0.0014582027, 0.00254442, 0.0040013813, 0.0057724603, 1.0], "tornado" => [0.0013122079, 0.004710326, 0.011888903, 0.022864908, 0.04753879, 1.0], "wind_adj" => [0.0028606635, 0.008563636, 0.017410113, 0.031802237, 0.060865648, 1.0], "sig_tornado" => [0.0007784463, 0.0033980992, 0.007858597, 0.013500211, 0.021512743, 1.0], "wind" => [0.008744916, 0.021842286, 0.04064058, 0.06938802, 0.122678265, 1.0])

# href_newer_event_to_bins = Dict{String, Vector{Float32}}(
#   "tornado"     => [0.0010191497,  0.0040240395, 0.009904478,  0.021118658, 0.04198461,  1.0],
#   "wind"        => [0.008220518,   0.020898983,  0.039187722,  0.067865305, 0.1211984,   1.0],
#   "hail"        => [0.0033015092,  0.00926606,   0.019275624,  0.03602357,  0.07374218,  1.0],
#   "sig_tornado" => [0.0006729238,  0.0026572358, 0.0057637123, 0.010840383, 0.02260619,  1.0],
#   "sig_wind"    => [0.0007965934,  0.0025051977, 0.0053047705, 0.008843536, 0.015871514, 1.0],
#   "sig_hail"    => [0.00077555457, 0.002129781,  0.004338203,  0.00847202,  0.018383306, 1.0],
# )



# 4. combine bin-pairs (overlapping, 5 bins total)
# 5. train a logistic regression for each bin, σ(a1*logit(HREF) + a2*logit(SREF) + b)
# For the 2020 models, adding more terms resulted in dangerously large coefficients
# There's more data this year...try interaction terms this time? nah

function find_logistic_coeffs(event_name, prediction_i, X, Ys, weights)
  y = Ys[event_name]
  ŷ = @view X[:,prediction_i]; # HREF prediction for event_name

  bins_max = event_to_bins[event_name]
  bins_logistic_coeffs = []

  # Paired, overlapping bins
  for bin_i in 1:(bin_count - 1)
    bin_min = bin_i >= 2 ? bins_max[bin_i-1] : -1f0
    bin_max = bins_max[bin_i+1]

    bin_members = (ŷ .> bin_min) .* (ŷ .<= bin_max)

    bin_href_x  = X[bin_members, prediction_i]
    bin_sref_x  = X[bin_members, prediction_i + event_types_count]
    # bin_ŷ       = ŷ[bin_members]
    bin_y       = y[bin_members]
    bin_weights = weights[bin_members]
    bin_weight  = sum(bin_weights)

    # logit(HREF), logit(SREF)
    bin_X_features = Array{Float32}(undef, (length(bin_y), 2))

    Threads.@threads :static for i in 1:length(bin_y)
      logit_href = logit(bin_href_x[i])
      logit_sref = logit(bin_sref_x[i])

      bin_X_features[i,1] = logit_href
      bin_X_features[i,2] = logit_sref
      # bin_X_features[i,3] = bin_X[i,1]*bin_X[i,2]
      # bin_X_features[i,3] = logit(bin_X[i,1]*bin_X[i,2])
      # bin_X_features[i,4] = logit(bin_X[i,1]*bin_X[i,2])
      # bin_X_features[i,5] = max(logit_href, logit_sref)
      # bin_X_features[i,6] = min(logit_href, logit_sref)
    end

    coeffs = LogisticRegression.fit(bin_X_features, bin_y, bin_weights; iteration_count = 300)

    # println("Fit logistic coefficients: $(coeffs)")

    logistic_ŷ = LogisticRegression.predict(bin_X_features, coeffs)

    stuff = [
      ("event_name", event_name),
      ("bin", "$bin_i-$(bin_i+1)"),
      ("HREF_ŷ_min", bin_min),
      ("HREF_ŷ_max", bin_max),
      ("count", length(bin_y)),
      ("pos_count", sum(bin_y)),
      ("weight", bin_weight),
      ("mean_HREF_ŷ", sum(bin_href_x .* bin_weights) / bin_weight),
      ("mean_SREF_ŷ", sum(bin_sref_x .* bin_weights) / bin_weight),
      ("mean_y", sum(bin_y .* bin_weights) / bin_weight),
      ("HREF_logloss", sum(logloss.(bin_y, bin_href_x) .* bin_weights) / bin_weight),
      ("SREF_logloss", sum(logloss.(bin_y, bin_sref_x) .* bin_weights) / bin_weight),
      ("HREF_au_pr", Float32(Metrics.area_under_pr_curve_fast(bin_href_x, bin_y, bin_weights))),
      ("SREF_au_pr", Float32(Metrics.area_under_pr_curve_fast(bin_sref_x, bin_y, bin_weights))),
      ("mean_logistic_ŷ", sum(logistic_ŷ .* bin_weights) / bin_weight),
      ("logistic_logloss", sum(logloss.(bin_y, logistic_ŷ) .* bin_weights) / bin_weight),
      ("logistic_au_pr", Float32(Metrics.area_under_pr_curve_fast(logistic_ŷ, bin_y, bin_weights))),
      ("logistic_coeffs", coeffs)
    ]

    headers = map(first, stuff)
    row     = map(last, stuff)

    bin_i == 1 && println(join(headers, "\t"))
    println(join(row, "\t"))

    push!(bins_logistic_coeffs, coeffs)
  end

  bins_logistic_coeffs
end

event_to_bins_logistic_coeffs = Dict{String,Vector{Vector{Float32}}}()
for prediction_i in 1:event_types_count
  event_name, _ = CombinedHREFSREF.models[prediction_i]

  event_to_bins_logistic_coeffs[event_name] = find_logistic_coeffs(event_name, prediction_i, X, Ys, weights)
end
print("href_newer_event_to_bins_logistic_coeffs = $event_to_bins_logistic_coeffs")

# href_newer_event_to_bins_logistic_coeffs = Dict{String, Vector{Vector{Float32}}}("sig_wind" => [[1.0237541, 0.07430771, 0.77363414], [0.9801676, 0.22527456, 1.4178667], [1.1523683, 0.2936303, 2.783076], [0.7023142, 0.22948036, 0.17595705], [0.49640635, 0.20968291, -0.77673304]], "sig_hail" => [[0.8787013, 0.3119461, 1.6104017], [0.7609628, 0.27349025, 0.5037077], [0.6508231, 0.3390255, 0.28728625], [0.562786, 0.35293543, -0.048666567], [0.63449466, 0.3219732, 0.13853967]], "hail" => [[0.8451918, 0.2678841, 0.7947575], [0.82366365, 0.1894165, 0.23550989], [0.9017725, 0.23303771, 0.7705032], [0.74698466, 0.2205954, 0.16990918], [0.86427146, 0.2018278, 0.43504176]], "sig_wind_adj" => [[1.127125, 0.052893594, 1.2472699], [1.5036446, 0.021982145, 3.6960568], [1.4205347, 0.16423136, 4.1276884], [1.5778238, 0.50511247, 7.107699], [0.1278618, 0.78106964, 0.9255426]], "tornado" => [[0.8548191, 0.2597601, 0.8644513], [0.78474545, 0.12277814, -0.4418093], [1.0832391, 0.038129725, 0.5669815], [0.75186867, 0.07035734, -0.6170576], [1.0223982, 0.12714103, 0.5787479]], "wind_adj" => [[0.9797254, 0.16798192, 0.8348953], [1.0740479, 0.15907931, 1.2374448], [1.0872117, 0.10037302, 1.0073562], [0.9246941, 0.19532852, 0.81610787], [0.73403955, 0.29090548, 0.62176204]], "sig_tornado" => [[0.7318563, 0.3246817, 0.37168285], [0.9523567, 0.26052013, 1.2165213], [1.473916, 0.17237528, 3.4237669], [1.3563457, 0.091417536, 2.4898052], [0.8635645, -0.0004715729, 0.056863528]], "wind" => [[0.9376985, 0.2066142, 0.70834965], [0.9932054, 0.15726718, 0.71593946], [1.0039783, 0.12171379, 0.6053313], [0.9382497, 0.13403365, 0.4595898], [0.74286795, 0.21366222, 0.2578835]])

# event_name   bin HREF_ŷ_min    HREF_ŷ_max   count     pos_count weight      mean_HREF_ŷ    mean_SREF_ŷ   mean_y        HREF_logloss  SREF_logloss  HREF_au_pr   SREF_au_pr    mean_logistic_ŷ logistic_logloss logistic_au_pr logistic_coeffs
# tornado      1-2 -1.0          0.004710326  569208379 22345.0   5.24565e8   3.9211784e-5   6.456604e-5   3.973716e-5   0.00031916535 0.0003422021  626.2121     0.0017128479  3.9737166e-5    0.0003167851     0.0027803837   Float32[0.8548191,  0.2597601,     0.8644513]0.78474545,    0.12277814,    -0.4418093]]]]
# tornado      2-3 0.0013122079  0.011888903  5781338   22177.0   5.4210245e6 0.0038389629   0.0038622334  0.003845271   0.024633836   0.026100308   0.006912483  0.005551187   0.003845271     0.024592128      0.0071537965   Float32[0.78474545, 0.12277814,    -0.4418093]1.0832391,    0.038129725,   0.5669815]]]2]
# tornado      3-4 0.004710326   0.022864908  2222363   22155.0   2.0968936e6 0.00995732     0.00783764    0.009940845   0.054473914   0.058511913   0.016806537  0.012086184   0.009940845     0.054453935      0.017166965    Float32[1.0832391,  0.038129725,   0.5669815]0.75186867,    0.07035734,    -0.6170576]]
# tornado      4-5 0.011888903   0.04753879   999229    22155.0   948425.6    0.022077415    0.014752411   0.021978687   0.104568295   0.112321176   0.03025382   0.02623725    0.02197869      0.10446822       0.03129944     Float32[0.75186867, 0.07035734,    -0.6170576]1.0223982,    0.12714103,    0.5787479]]]
# tornado      5-6 0.022864908   1.0          499578    21984.0   476384.62   0.042412676    0.025556246   0.04374988    0.17315565    0.187718      0.085585535  0.06508306    0.04374988      0.17282005       0.086502574    Float32[1.0223982,  0.12714103,    0.5787479]0.9376985,     0.2066142,     0.70834965]6]8]5]]
# event_name   bin HREF_ŷ_min    HREF_ŷ_max   count     pos_count weight      mean_HREF_ŷ    mean_SREF_ŷ   mean_y        HREF_logloss  SREF_logloss  HREF_au_pr   SREF_au_pr    mean_logistic_ŷ logistic_logloss logistic_au_pr logistic_coeffs
# wind         1-2 -1.0          0.021842286  566591005 174683.0  5.221692e8  0.00033449524  0.00048726308 0.00031137464 0.0019269972  0.0020963203  0.013521824  0.009107277   0.0003113746    0.0019158684     0.014616285    Float32[0.9376985,  0.2066142,     0.70834965]0.9932054,    0.15726718,    0.71593946]]]]
# wind         2-3 0.008744916   0.04064058   8803587   174950.0  8.2099655e6 0.018622948    0.016239984   0.019803917   0.09495567    0.10050158    0.03273339   0.02709696    0.019803915     0.09469265       0.03376097     Float32[0.9932054,  0.15726718,    0.71593946]1.0039783,    0.12171379,    0.6053313]]1]
# wind         3-4 0.021842286   0.06938802   4101450   174955.0  3.8202078e6 0.03757928     0.026926853   0.042560276   0.17345326    0.18705434    0.061311703  0.05200345    0.042560272     0.17288563       0.062932536    Float32[1.0039783,  0.12171379,    0.6053313]0.9382497,     0.13403365,    0.4595898]3]]
# wind         4-5 0.04064058    0.122678265  2248953   174718.0  2.0916174e6 0.06618799     0.04108688    0.077734      0.26984674    0.29702047    18.022213    0.09432323    0.077734        0.26842478       0.11014767     Float32[0.9382497,  0.13403365,    0.4595898]0.74286795,    0.21366222,    0.2578835]]1]
# wind         5-6 0.06938802    1.0          1237865   174485.0  1.148873e6  0.12363328     0.06805951    0.14151917    0.39492828    0.44385427    0.23323557   0.2199623     0.14151916      0.39200872       0.24133481     Float32[0.74286795, 0.21366222,    0.2578835]0.9797254,     0.16798192,    0.8348953]]]]]4]5]]
# event_name   bin HREF_ŷ_min    HREF_ŷ_max   count     pos_count weight      mean_HREF_ŷ    mean_SREF_ŷ   mean_y        HREF_logloss  SREF_logloss  HREF_au_pr   SREF_au_pr    mean_logistic_ŷ logistic_logloss logistic_au_pr logistic_coeffs
# wind_adj     1-2 -1.0          0.008563636  568404909 52647.34  5.2389936e8 0.000105606894 0.00015426897 9.27926e-5    0.0006803202  0.00073936256 -336.9143    0.0031073175  9.2792594e-5    0.0006765985     0.0051007713   Float32[0.9797254,  0.16798192,    0.8348953]1.0740479,     0.15907931,    1.2374448]]1]]
# wind_adj     2-3 0.0028606635  0.017410113  7566482   52775.227 6.990983e6  0.006718954    0.0060438905  0.00695387    0.040193256   0.042339977   0.013645499  0.010509981   0.0069538704    0.040073097      0.0141548915   Float32[1.0740479,  0.15907931,    1.2374448]1.0872117,     0.10037302,    1.0073562]]]]
# wind_adj     3-4 0.008563636   0.031802237  2839518   52860.727 2.6136482e6 0.015582897    0.0113053005  0.018600188   0.09106082    0.0979951     0.028901337  0.024454327   0.018600188     0.09067247       0.030298846    Float32[1.0872117,  0.10037302,    1.0073562]0.9246941,     0.19532852,    0.81610787]]
# wind_adj     4-5 0.017410113   0.060865648  1376524   52972.758 1.2615952e6 0.02985603     0.0185977     0.038533863   0.16157289    0.17552921    0.057814516  0.055107273   0.038533863     0.15990607       0.06342116     Float32[0.9246941,  0.19532852,    0.81610787]0.73403955,   0.29090548,    0.62176204]
# wind_adj     5-6 0.031802237   1.0          685893    53250.652 625262.1    0.058943056    0.030459194   0.077745065   0.26776332    0.29967275    0.13099499   0.1240383     0.07774505      0.2632397        0.13559605     Float32[0.73403955, 0.29090548,    0.62176204]0.8451918,    0.2678841,     0.7947575]27]08]6]
# event_name   bin HREF_ŷ_min    HREF_ŷ_max   count     pos_count weight      mean_HREF_ŷ    mean_SREF_ŷ   mean_y        HREF_logloss  SREF_logloss  HREF_au_pr   SREF_au_pr    mean_logistic_ŷ logistic_logloss logistic_au_pr logistic_coeffs
# hail         1-2 -1.0          0.009600723  566981560 79203.0   5.225545e8  0.00012913495  0.00020661621 0.00014060138 0.0009784885  0.0010443097  0.0059510986 0.004502483   0.00014060139   0.00097103784    0.006586433    Float32[0.8451918,  0.2678841,     0.7947575]0.82366365,    0.1894165,     0.23550989]2]]
# hail         2-3 0.003458654   0.020057917  8790935   78861.0   8.159157e6  0.008192031    0.007832335   0.009004928   0.050347976   0.052898232   0.015294408  0.013610849   0.009004928     0.050146703      0.01655904     Float32[0.82366365, 0.1894165,     0.23550989]0.9017725,    0.23303771,    0.7705032]]]
# hail         3-4 0.009600723   0.037324984  3944739   79079.0   3.6542175e6 0.018018974    0.013768457   0.020106135   0.09679822    0.101909146   0.030801788  0.028565135   0.020106131     0.09623319       0.033326298    Float32[0.9017725,  0.23303771,    0.7705032]0.74698466,    0.2205954,     0.16990918]]
# hail         4-5 0.020057917   0.076065265  1984190   79461.0   1.8359385e6 0.035702016    0.022753712   0.04001863    0.16577706    0.17767467    0.05758951   0.053603645   0.040018626     0.16485053       0.060501777    Float32[0.74698466, 0.2205954,     0.16990918]0.86427146,   0.2018278,     0.43504176]]4]
# hail         5-6 0.037324984   1.0          1004021   79498.0   929559.8    0.0721943      0.03907389    0.07903699    0.2649131     0.2933911     0.1583389    0.1301408     0.079036996     0.26372224       0.1625015      Float32[0.86427146, 0.2018278,     0.43504176]0.7318563,    0.3246817,     0.37168285]6]]7]6]]
# event_name   bin HREF_ŷ_min    HREF_ŷ_max   count     pos_count weight      mean_HREF_ŷ    mean_SREF_ŷ   mean_y        HREF_logloss  SREF_logloss  HREF_au_pr   SREF_au_pr    mean_logistic_ŷ logistic_logloss logistic_au_pr logistic_coeffs
# sig_tornado  1-2 -1.0          0.0033980992 571415613 3157.0    5.2664586e8 6.4524893e-6   1.0411996e-5  5.663919e-6   5.0117e-5     5.368466e-5   -270.88776   0.0014564153  5.663916e-6     4.956414e-5      0.002010731    Float32[0.7318563,  0.3246817,     0.37168285]0.9523567,    0.26052013,    1.2165213]]]]]]
# sig_tornado  2-3 0.0007784463  0.007858597  1527517   3099.0    1.4483592e6 0.0023718947   0.0022824816  0.0020592783  0.014226993   0.014800945   0.004824943  0.004631331   0.0020592778    0.014103547      0.00553721     Float32[0.9523567,  0.26052013,    1.2165213]1.473916,      0.17237528,    3.4237669]]0596]
# sig_tornado  3-4 0.0033980992  0.013500211  434467    3092.0    415090.38   0.0062952642   0.00516174    0.0071848864  0.041422654   0.043839168   0.0152505385 0.009980408   0.007184887     0.041027498      0.015249469    Float32[1.473916,   0.17237528,    3.4237669]1.3563457,     0.091417536,   2.4898052]]9]
# sig_tornado  4-5 0.007858597   0.021512743  154873    3093.0    148833.81   0.012311208    0.009323702   0.020040588   0.09868011    0.10735906    -4.9521246   0.02154685    0.020040585     0.096375324      0.030057909    Float32[1.3563457,  0.091417536,   2.4898052]0.8635645,     -0.0004715729, 0.056863528]
# sig_tornado  5-6 0.013500211   1.0          80240     3106.0    77358.25    0.022298414    0.015005912   0.038522772   0.16609094    0.18613957    0.05745042   0.041383285   0.038522772     0.16103002       0.05737542     Float32[0.8635645,  -0.0004715729, 0.056863528]1.0237541,   0.07430771,    0.77363414]]]7]]]3]
# event_name   bin HREF_ŷ_min    HREF_ŷ_max   count     pos_count weight      mean_HREF_ŷ    mean_SREF_ŷ   mean_y        HREF_logloss  SREF_logloss  HREF_au_pr   SREF_au_pr    mean_logistic_ŷ logistic_logloss logistic_au_pr logistic_coeffs
# sig_wind     1-2 -1.0          0.0025200176 568154559 17088.0   5.2363437e8 2.9773972e-5   4.973542e-5   3.03213e-5    0.00025720775 0.00028017446 0.0011859061 0.0011574271  3.0321298e-5    0.0002568317     0.0014549745   Float32[1.0237541,  0.07430771,    0.77363414]0.9801676,    0.22527456,    1.4178667]]1]3]
# sig_wind     2-3 0.00076082407 0.0051898635 8088333   17092.0   7.52384e6   0.0019395489   0.0018818339  0.0021102298  0.014713033   0.015254561   0.0043461253 0.0044309245  0.0021102296    0.014650906      0.00510347     Float32[0.9801676,  0.22527456,    1.4178667]1.1523683,     0.2936303,     2.783076]]]3]4]
# sig_wind     3-4 0.0025200176  0.008781022  2940741   17123.0   2.7315768e6 0.004526102    0.0033781028  0.005812564   0.03525174    0.036748037   0.008891232  0.009010606   0.005812564     0.034847397      0.010287465    Float32[1.1523683,  0.2936303,     2.783076]0.7023142,      0.22948036,    0.17595705]]]
# sig_wind     4-5 0.0051898635  0.016167704  1449093   17113.0   1.3438842e6 0.008566266    0.005229259   0.011815105   0.06429231    0.06883264    -25.194296   0.015967341   0.011815103     0.06351321       0.017294403    Float32[0.7023142,  0.22948036,    0.17595705]0.49640635,   0.20968291,    -0.77673304]
# sig_wind     5-6 0.008781022   1.0          835020    17165.0   772316.25   0.017334769    0.008378071   0.020554679   0.09959018    0.10863672    0.031550676  0.02929273    0.020554679     0.09849223       0.032775298    Float32[0.49640635, 0.20968291,    -0.77673304]1.127125,    0.052893594,   1.2472699]]5]]]]]]
# event_name   bin HREF_ŷ_min    HREF_ŷ_max   count     pos_count weight      mean_HREF_ŷ    mean_SREF_ŷ   mean_y        HREF_logloss  SREF_logloss  HREF_au_pr   SREF_au_pr    mean_logistic_ŷ logistic_logloss logistic_au_pr logistic_coeffs
# sig_wind_adj 1-2 -1.0          0.0014582027 570073265 5976.3447 5.2544336e8 1.3260324e-5   1.8264205e-5  1.0511677e-5  9.663733e-5   0.00010482192 0.0006804231 0.00047342628 1.0511673e-5    9.598097e-5      0.0007029565   Float32[1.127125,   0.052893594,   1.2472699]1.5036446,     0.021982145,   3.6960568]6]]2]
# sig_wind_adj 2-3 0.0005631988  0.00254442   4354061   6021.371  4.0048805e6 0.0011351769   0.0009954472  0.0013791606  0.010227289   0.010770103   0.002372932  0.0019563052  0.0013791608    0.010168242      0.0027636199   Float32[1.5036446,  0.021982145,   3.6960568]1.4205347,     0.16423136,    4.1276884]53]]]
# sig_wind_adj 3-4 0.0014582027  0.0040013813 1536512   6043.708  1.4040864e6 0.0022987134   0.0018911178  0.003933975   0.025846425   0.02701207    0.0063189953 0.005915751   0.003933975     0.025277013      0.0077176937   Float32[1.4205347,  0.16423136,    4.1276884]1.5778238,     0.50511247,    7.107699]]]]]
# sig_wind_adj 4-5 0.00254442    0.0057724603 690467    6046.878  627908.7    0.0035993038   0.0028931797  0.008797402   0.052323934   0.05348964    -754.5257    0.017745601   0.008797403     0.04874606       0.020440323    Float32[1.5778238,  0.50511247,    7.107699]0.1278618,      0.78106964,    0.9255426]4]]
# sig_wind_adj 5-6 0.0040013813  1.0          320543    6072.8413 290812.44   0.005930609    0.0048314314  0.018990444   0.102262706   0.102556184   0.026798423  0.04416696    0.018990444     0.090314254      0.044231992    Float32[0.1278618,  0.78106964,    0.9255426]0.8787013,     0.3119461,     1.6104017]5]]7]]
# event_name   bin HREF_ŷ_min    HREF_ŷ_max   count     pos_count weight      mean_HREF_ŷ    mean_SREF_ŷ   mean_y        HREF_logloss  SREF_logloss  HREF_au_pr   SREF_au_pr    mean_logistic_ŷ logistic_logloss logistic_au_pr logistic_coeffs
# sig_hail     1-2 -1.0          0.0022382603 569596459 9278.0    5.2497238e8 1.4782402e-5   2.6558637e-5  1.6486398e-5  0.00013887089 0.00014903312 0.0013314564 0.00082229695 1.6486392e-5    0.00013720112    0.0015203905   Float32[0.8787013,  0.3119461,     1.6104017]0.7609628,     0.27349025,    0.5037077]]3]]]
# sig_hail     2-3 0.0007729447  0.0047318107 4232683   9301.0    3.9274808e6 0.001876877    0.0018059806  0.0022036943  0.015428084   0.016026685   -975.4603    0.004061431   0.0022036943    0.015295155      0.005062829    Float32[0.7609628,  0.27349025,    0.5037077]0.6508231,     0.3390255,     0.28728625]]]]]]
# sig_hail     3-4 0.0022382603  0.009228747  1869527   9358.0    1.7325788e6 0.004318088    0.0034092576  0.0049954024  0.031148706   0.032184917   0.0071835946 0.009115861   0.004995401     0.03078179       0.009413696    Float32[0.6508231,  0.3390255,     0.28728625]0.562786,     0.35293543,    -0.048666567]]]
# sig_hail     4-5 0.0047318107  0.020026933  955018    9334.0    886772.9    0.008787836    0.0060045337  0.009760632   0.054368727   0.05646796    0.014208983  0.016647581   0.009760633     0.05371758       0.01737455     Float32[0.562786,   0.35293543,    -0.048666567]0.63449466, 0.3219732,     0.13853967]5]
# sig_hail     5-6 0.009228747   1.0          464334    9249.0    433322.44   0.019193677    0.011113506   0.019969653   0.09513787    0.100518756   0.03933925   0.03493383    0.019969657     0.09425095       0.042098153    Float32[0.63449466, 0.3219732,     0.13853967]


# 6. prediction is weighted mean of the two overlapping logistic models
# 7. predictions should thereby be calibrated (check)




# CHECKING CALIBRATION

import Dates

push!(LOAD_PATH, (@__DIR__) * "/../shared")
# import TrainGBDTShared
import TrainingShared
import LogisticRegression
using Metrics

push!(LOAD_PATH, @__DIR__)
import CombinedHREFSREF

push!(LOAD_PATH, (@__DIR__) * "/../../lib")
import Forecasts
import Inventories


(_, combined_validation_forecasts, _) = TrainingShared.forecasts_train_validation_test(CombinedHREFSREF.forecasts_href_newer_combined_with_sig_gated(); just_hours_near_storm_events = false);

length(combined_validation_forecasts) # 21318

# We don't have storm events past this time.
cutoff = Dates.DateTime(2022, 6, 1, 12)
combined_validation_forecasts = filter(forecast -> Forecasts.valid_utc_datetime(forecast) < cutoff, combined_validation_forecasts);

length(combined_validation_forecasts) # 17918

# Make sure a forecast loads
Forecasts.data(combined_validation_forecasts[100])

# rm("combined_validation_forecasts_href_newer_with_sig_gated"; recursive=true)

X, Ys, weights = TrainingShared.get_data_labels_weights(combined_validation_forecasts; event_name_to_labeler = TrainingShared.event_name_to_labeler, save_dir = "combined_validation_forecasts_href_newer_with_sig_gated");


# Should be higher AU-PR compared to HREF-only

function test_predictive_power(forecasts, X, Ys, weights)
  inventory = Forecasts.inventory(forecasts[1])

  for feature_i in 1:length(inventory)
    prediction_i = 1 + (feature_i - 1) % CombinedHREFSREF.models_with_gated_count
    (event_name, _, model_name) = CombinedHREFSREF.models_with_gated[prediction_i]
    y = Ys[event_name]
    x = @view X[:,feature_i]
    au_pr_curve = Float32(Metrics.area_under_pr_curve(x, y, weights))
    println("$model_name ($(sum(y))) feature $feature_i $(Inventories.inventory_line_description(inventory[feature_i]))\tAU-PR-curve: $au_pr_curve")
  end
end
test_predictive_power(combined_validation_forecasts, X, Ys, weights)

# tornado (66484.0)                          feature 1 TORPROB:calculated:hour fcst:calculated_prob:                    AU-PR-curve: 0.04131236889800144
# wind (524123.0)                            feature 2 WINDPROB:calculated:hour fcst:calculated_prob:                   AU-PR-curve: 0.12668607422859954
# wind_adj (158758.72)                       feature 3 WINDPROB:calculated:hour fcst:calculated_prob:                   AU-PR-curve: 0.06745856052922919
# hail (237780.0)                            feature 4 HAILPROB:calculated:hour fcst:calculated_prob:                   AU-PR-curve: 0.07840802090299613
# sig_tornado (9355.0)                       feature 5 STORPROB:calculated:hour fcst:calculated_prob:                   AU-PR-curve: 0.029540473635952528
# sig_wind (51376.0)                         feature 6 SWINDPRO:calculated:hour fcst:calculated_prob:                   AU-PR-curve: 0.017541836676065636
# sig_wind_adj (18092.895)                   feature 7 SWINDPRO:calculated:hour fcst:calculated_prob:                   AU-PR-curve: 0.020241123416476256
# sig_hail (27885.0)                         feature 8 SHAILPRO:calculated:hour fcst:calculated_prob:                   AU-PR-curve: 0.020344744327128506
# sig_tornado_gated_by_tornado (9355.0)      feature 9 STORPROB:calculated:hour fcst:calculated_prob:gated by tornado   AU-PR-curve: 0.02708157337777957
# sig_wind_gated_by_wind (51376.0)           feature 10 SWINDPRO:calculated:hour fcst:calculated_prob:gated by wind     AU-PR-curve: 0.01754418331777714
# sig_wind_adj_gated_by_wind_adj (18092.895) feature 11 SWINDPRO:calculated:hour fcst:calculated_prob:gated by wind_adj AU-PR-curve: 0.020937532939070993
# sig_hail_gated_by_hail (27885.0)           feature 12 SHAILPRO:calculated:hour fcst:calculated_prob:gated by hail     AU-PR-curve: 0.02034246406420043


Metrics.reliability_curves_midpoints(20, X, Ys, map(m -> m[1], CombinedHREFSREF.models_with_gated), weights, map(m -> m[3], CombinedHREFSREF.models_with_gated))
# ŷ_tornado,y_tornado,ŷ_wind,y_wind,ŷ_wind_adj,y_wind_adj,ŷ_hail,y_hail,ŷ_sig_tornado,y_sig_tornado,ŷ_sig_wind,y_sig_wind,ŷ_sig_wind_adj,y_sig_wind_adj,ŷ_sig_hail,y_sig_hail,ŷ_sig_tornado_gated_by_tornado,y_sig_tornado_gated_by_tornado,ŷ_sig_wind_gated_by_wind,y_sig_wind_gated_by_wind,ŷ_sig_wind_adj_gated_by_wind_adj,y_sig_wind_adj_gated_by_wind_adj,ŷ_sig_hail_gated_by_hail,y_sig_hail_gated_by_hail,
# 6.329379e-6,6.1523447e-6,4.6505895e-5,4.8610418e-5,1.3742093e-5,1.4457822e-5,2.1873784e-5,2.188734e-5,7.20755e-7,8.6109696e-7,4.644935e-6,4.7292183e-6,1.4785052e-6,1.6219028e-6,2.41135e-6,2.5182753e-6,6.995698e-7,8.610824e-7,4.6224504e-6,4.7290314e-6,1.4727707e-6,1.6211175e-6,2.4100052e-6,2.5182628e-6,
# 0.00033425025,0.00037874634,0.0026074534,0.002621135,0.0007411769,0.0008071455,0.0012213688,0.0012956854,7.735059e-5,0.00014343958,0.00021968028,0.00026465312,0.00011978365,0.000107939675,0.0002634123,0.00031965895,7.734998e-5,0.00014366614,0.00021963651,0.00026512364,0.000119721946,0.00010971431,0.0002633984,0.00031970392,
# 0.00084459485,0.00089789357,0.005597663,0.0054004304,0.0016561502,0.0016568619,0.0025559517,0.0027526282,0.0002993257,0.00024027909,0.00049264065,0.0005540822,0.0002969556,0.00027695458,0.0005619799,0.00066488114,0.0002993361,0.00024057865,0.0004924574,0.0005543945,0.0002964037,0.00028286362,0.0005619813,0.0006650193,
# 0.0015727014,0.0016646438,0.009161773,0.009019757,0.0028927778,0.0027136863,0.004146102,0.004285399,0.0007870472,0.0007495787,0.0008583023,0.0008562508,0.0005144352,0.00050777744,0.0009822149,0.00085898314,0.0007865613,0.0007519982,0.0008581765,0.0008562496,0.00051348703,0.0005120706,0.0009822149,0.00085927127,
# 0.002477754,0.0025377765,0.013202644,0.012906723,0.004458846,0.004255939,0.006007072,0.0060761506,0.0013981952,0.0011366126,0.0013152491,0.0012663509,0.0007861299,0.00076269015,0.0015127546,0.0015338428,0.0013932656,0.0011461402,0.0013152608,0.0012668978,0.00078594626,0.0007741258,0.0015127568,0.00153431,
# 0.0035379417,0.0032954107,0.017725201,0.017990526,0.0063556507,0.0064398763,0.008096463,0.0077625597,0.0022156977,0.0020044926,0.0018899285,0.0017272178,0.0012038063,0.0010732,0.0020242713,0.0021552618,0.0022035078,0.0019941826,0.0018899338,0.0017276406,0.0012034213,0.0010839899,0.0020242713,0.0021561808,
# 0.004692288,0.0044802018,0.02277298,0.022951791,0.008671504,0.008817938,0.010406151,0.009775523,0.0031726258,0.0030208128,0.0026585124,0.002328765,0.0017798012,0.0019056003,0.0025749386,0.0025906812,0.0031632832,0.0029746743,0.0026585166,0.0023290883,0.0017787684,0.0019242548,0.0025749418,0.002592116,
# 0.005977948,0.0061160442,0.028533412,0.028482646,0.011508315,0.011635455,0.013046307,0.012577711,0.0043670256,0.004290463,0.0036495854,0.0033623783,0.0023715994,0.002461212,0.003231267,0.003136932,0.0043653254,0.004273485,0.0036495638,0.003363015,0.00237073,0.0024946788,0.0032312844,0.003137784,
# 0.0077460846,0.007608793,0.035122342,0.035051152,0.014868246,0.014742481,0.016328719,0.016138926,0.0059613036,0.006287434,0.0048141605,0.004921603,0.0030656925,0.0030518083,0.0040474,0.0039006465,0.0059447465,0.0063796854,0.0048141633,0.004922662,0.0030614184,0.0031129706,0.0040474194,0.0039013396,
# 0.010293216,0.009666786,0.04242923,0.043286823,0.01876894,0.018770633,0.020451631,0.02036212,0.008202736,0.008510425,0.0061837053,0.006835582,0.0038273325,0.004225517,0.005060797,0.00486127,0.008112739,0.008631641,0.0061836825,0.006834806,0.0038183895,0.004258926,0.005060781,0.004862395,
# 0.013566963,0.013671846,0.05061548,0.050791632,0.0231067,0.023821242,0.025425151,0.025856292,0.011254426,0.011364172,0.007785132,0.008369782,0.004707345,0.004495147,0.006315176,0.00592723,0.011052563,0.01129339,0.0077851033,0.008368972,0.0046981242,0.0045328266,0.0063151782,0.0059282146,
# 0.016903339,0.017927356,0.06034365,0.059132185,0.028365294,0.028391,0.030985646,0.03219771,0.015086732,0.013273155,0.009479886,0.0101753995,0.0059527378,0.0056575444,0.007823914,0.0075763264,0.014444277,0.015432531,0.009479882,0.010175055,0.005943538,0.0056775534,0.00782395,0.0075761634,
# 0.020169068,0.020313416,0.07147149,0.07116048,0.03476211,0.034419917,0.037150577,0.037670918,0.019257396,0.021766841,0.0111412695,0.01185034,0.0077920808,0.007446355,0.009581121,0.0093621975,0.017861977,0.021901077,0.011141207,0.011849456,0.007783467,0.0074664424,0.009581085,0.009362096,
# 0.02341534,0.025220253,0.084188774,0.08508091,0.042847738,0.040601537,0.044266827,0.044394616,0.02337956,0.025808362,0.012947015,0.012103536,0.010442056,0.009084584,0.011650811,0.012007177,0.02146952,0.02424011,0.012946857,0.0121080475,0.01042869,0.009136545,0.011650817,0.012007183,
# 0.027525356,0.028008724,0.09921064,0.10101609,0.05309993,0.051306747,0.05301119,0.053574447,0.028216556,0.030454924,0.015109891,0.013982104,0.013990373,0.011312523,0.014146429,0.014548714,0.025915854,0.026687698,0.015109943,0.013991242,0.013954224,0.011460255,0.0141464,0.014548919,
# 0.034414403,0.0301137,0.11681327,0.11973375,0.06529327,0.06640719,0.06466346,0.06426368,0.03318613,0.03227601,0.017659985,0.016683722,0.018082373,0.017679902,0.017358098,0.017805558,0.031198513,0.030022977,0.017660031,0.01668727,0.017975023,0.018085605,0.017357673,0.017809607,
# 0.046259664,0.04233483,0.13868651,0.13792904,0.08026062,0.08418904,0.081140526,0.080530874,0.037365463,0.03605875,0.020583052,0.021129113,0.02236617,0.027609492,0.021783061,0.021987207,0.036016203,0.03485307,0.020583086,0.021132661,0.02218904,0.027763825,0.02178294,0.021989707,
# 0.06107447,0.06855975,0.16881843,0.16794659,0.09940913,0.10906282,0.105405435,0.10154764,0.043302733,0.037647616,0.02427349,0.025210083,0.027138574,0.03790646,0.02815816,0.029829264,0.040998977,0.039853197,0.024273561,0.025212092,0.026989086,0.03799084,0.028158182,0.029831832,
# 0.0805086,0.08941588,0.21825297,0.21475472,0.12663072,0.13796979,0.14465673,0.13975339,0.054354627,0.052465443,0.029606715,0.03962417,0.034104124,0.041589096,0.038242098,0.039199986,0.05022618,0.04902017,0.029606717,0.039623585,0.033997234,0.043108083,0.03823031,0.039256625,
# 0.12834552,0.1256149,0.33516818,0.3401993,0.19395424,0.18060741,0.23145328,0.24076703,0.078047335,0.09263401,0.04585802,0.04351898,0.055199657,0.049461465,0.064198434,0.061935894,0.07308369,0.07113278,0.04585919,0.043524515,0.054285504,0.052423857,0.064154595,0.06179864,
