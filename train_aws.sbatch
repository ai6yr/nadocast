#!/bin/bash
#SBATCH --exclusive
#SBATCH --ntasks-per-node=1
#SBATCH --output=%x_%J_stdout.txt
#SBATCH --error=%x_%J_stderr.txt
#SBATCH --time=7-00:00:00
#SBATCH --mail-user=brian.hempel@noaa.gov
#SBATCH --mail-type=ALL

# Queue Count Model         vCPU Memory (GiB) Instance Storage (GB) Network Bandwidth (Gbps) EBS Bandwidth (Mbps)
# spc-1 12    c5.24xlarge   96   192          EBS-Only              25                       19,000
# spc-2 8     c5n.18xlarge  72   192          EBS-Only              100                      19,000
# spc-3 6     m5n.24xlarge  96   384          EBS-Only              100                      19,000
# spc-4 4     m6i.32xlarge  128  512          EBS-Only              50                       40,000

# USAGE: DATA_ROOT=$(pwd) PARTITION=spc-1 NODES=3 CPUS_PER_TASK=48 SREF_OR_HREF=href FORECAST_HOUR_START=2 FORECAST_HOUR_STOP=13 DATA_SUBSET_RATIO=0.03 NEAR_STORM_RATIO=0.4 EVENT_TYPES=wind_adj,sig_hail,hail,sig_wind_adj,sig_tornado,sig_wind,tornado,wind; DATA_ROOT=$DATA_ROOT SREF_OR_HREF=$SREF_OR_HREF FORECAST_HOUR_START=$FORECAST_HOUR_START FORECAST_HOUR_STOP=$FORECAST_HOUR_STOP DATA_SUBSET_RATIO=$DATA_SUBSET_RATIO NEAR_STORM_RATIO=$NEAR_STORM_RATIO EVENT_TYPES=$EVENT_TYPES sbatch --partition=$PARTITION --nodes=$NODES --cpus-per-task=$CPUS_PER_TASK --job-name=train_${SREF_OR_HREF}_f${FORECAST_HOUR_START}-${FORECAST_HOUR_STOP}_${DATA_SUBSET_RATIO}_${NEAR_STORM_RATIO}_${EVENT_TYPES} /scratch/nadocast_dev/train_aws.sbatch
# DATA_ROOT=$(pwd) PARTITION=spc-1 NODES=3 CPUS_PER_TASK=48 SREF_OR_HREF=sref FORECAST_HOUR_START=2 FORECAST_HOUR_STOP=13 DATA_SUBSET_RATIO=0.3 NEAR_STORM_RATIO= EVENT_TYPES=wind_adj,sig_hail,hail,sig_wind_adj,sig_tornado,sig_wind,tornado,wind; DATA_ROOT=$DATA_ROOT SREF_OR_HREF=$SREF_OR_HREF FORECAST_HOUR_START=$FORECAST_HOUR_START FORECAST_HOUR_STOP=$FORECAST_HOUR_STOP DATA_SUBSET_RATIO=$DATA_SUBSET_RATIO NEAR_STORM_RATIO=$NEAR_STORM_RATIO EVENT_TYPES=$EVENT_TYPES sbatch --partition=$PARTITION --nodes=$NODES --cpus-per-task=$CPUS_PER_TASK --job-name=train_${SREF_OR_HREF}_f${FORECAST_HOUR_START}-${FORECAST_HOUR_STOP}_${DATA_SUBSET_RATIO}_${NEAR_STORM_RATIO}_${EVENT_TYPES} /scratch/nadocast_dev/train_aws.sbatch

# 1 DATA_ROOT=$(pwd) PARTITION=spc-1 NODES=3 CPUS_PER_TASK=48 SREF_OR_HREF=sref FORECAST_HOUR_START=12 FORECAST_HOUR_STOP=23 DATA_SUBSET_RATIO=0.3 NEAR_STORM_RATIO= EVENT_TYPES=wind_adj,sig_hail,hail,sig_wind_adj; DATA_ROOT=$DATA_ROOT SREF_OR_HREF=$SREF_OR_HREF FORECAST_HOUR_START=$FORECAST_HOUR_START FORECAST_HOUR_STOP=$FORECAST_HOUR_STOP DATA_SUBSET_RATIO=$DATA_SUBSET_RATIO NEAR_STORM_RATIO=$NEAR_STORM_RATIO EVENT_TYPES=$EVENT_TYPES sbatch --partition=$PARTITION --nodes=$NODES --cpus-per-task=$CPUS_PER_TASK --job-name=train_${SREF_OR_HREF}_f${FORECAST_HOUR_START}-${FORECAST_HOUR_STOP}_${DATA_SUBSET_RATIO}_${NEAR_STORM_RATIO}_${EVENT_TYPES} /scratch/nadocast_dev/train_aws.sbatch
# 2 DATA_ROOT=$(pwd) PARTITION=spc-2 NODES=4 CPUS_PER_TASK=36 SREF_OR_HREF=sref FORECAST_HOUR_START=12 FORECAST_HOUR_STOP=23 DATA_SUBSET_RATIO=0.3 NEAR_STORM_RATIO= EVENT_TYPES=sig_tornado,sig_wind,tornado,wind; DATA_ROOT=$DATA_ROOT SREF_OR_HREF=$SREF_OR_HREF FORECAST_HOUR_START=$FORECAST_HOUR_START FORECAST_HOUR_STOP=$FORECAST_HOUR_STOP DATA_SUBSET_RATIO=$DATA_SUBSET_RATIO NEAR_STORM_RATIO=$NEAR_STORM_RATIO EVENT_TYPES=$EVENT_TYPES sbatch --partition=$PARTITION --nodes=$NODES --cpus-per-task=$CPUS_PER_TASK --job-name=train_${SREF_OR_HREF}_f${FORECAST_HOUR_START}-${FORECAST_HOUR_STOP}_${DATA_SUBSET_RATIO}_${NEAR_STORM_RATIO}_${EVENT_TYPES} /scratch/nadocast_dev/train_aws.sbatch
# 3 DATA_ROOT=$(pwd) PARTITION=spc-3 NODES=3 CPUS_PER_TASK=48 SREF_OR_HREF=sref FORECAST_HOUR_START=21 FORECAST_HOUR_STOP=38 DATA_SUBSET_RATIO=0.2 NEAR_STORM_RATIO= EVENT_TYPES=wind_adj,sig_hail,hail,sig_wind_adj; DATA_ROOT=$DATA_ROOT SREF_OR_HREF=$SREF_OR_HREF FORECAST_HOUR_START=$FORECAST_HOUR_START FORECAST_HOUR_STOP=$FORECAST_HOUR_STOP DATA_SUBSET_RATIO=$DATA_SUBSET_RATIO NEAR_STORM_RATIO=$NEAR_STORM_RATIO EVENT_TYPES=$EVENT_TYPES sbatch --partition=$PARTITION --nodes=$NODES --cpus-per-task=$CPUS_PER_TASK --job-name=train_${SREF_OR_HREF}_f${FORECAST_HOUR_START}-${FORECAST_HOUR_STOP}_${DATA_SUBSET_RATIO}_${NEAR_STORM_RATIO}_${EVENT_TYPES} /scratch/nadocast_dev/train_aws.sbatch
# 8 DATA_ROOT=$(pwd) PARTITION=spc-1 NODES=3 CPUS_PER_TASK=48 SREF_OR_HREF=sref FORECAST_HOUR_START=21 FORECAST_HOUR_STOP=38 DATA_SUBSET_RATIO=0.2 NEAR_STORM_RATIO= EVENT_TYPES=sig_tornado,sig_wind,tornado,wind; DATA_ROOT=$DATA_ROOT SREF_OR_HREF=$SREF_OR_HREF FORECAST_HOUR_START=$FORECAST_HOUR_START FORECAST_HOUR_STOP=$FORECAST_HOUR_STOP DATA_SUBSET_RATIO=$DATA_SUBSET_RATIO NEAR_STORM_RATIO=$NEAR_STORM_RATIO EVENT_TYPES=$EVENT_TYPES sbatch --partition=$PARTITION --nodes=$NODES --cpus-per-task=$CPUS_PER_TASK --job-name=train_${SREF_OR_HREF}_f${FORECAST_HOUR_START}-${FORECAST_HOUR_STOP}_${DATA_SUBSET_RATIO}_${NEAR_STORM_RATIO}_${EVENT_TYPES} /scratch/nadocast_dev/train_aws.sbatch

# 7 DATA_ROOT=$(pwd) PARTITION=spc-3 NODES=3 CPUS_PER_TASK=48 SREF_OR_HREF=href FORECAST_HOUR_START=24 FORECAST_HOUR_STOP=35 DATA_SUBSET_RATIO=0.03 NEAR_STORM_RATIO=0.4 EVENT_TYPES=wind_adj,sig_hail,hail,sig_wind_adj; DATA_ROOT=$DATA_ROOT SREF_OR_HREF=$SREF_OR_HREF FORECAST_HOUR_START=$FORECAST_HOUR_START FORECAST_HOUR_STOP=$FORECAST_HOUR_STOP DATA_SUBSET_RATIO=$DATA_SUBSET_RATIO NEAR_STORM_RATIO=$NEAR_STORM_RATIO EVENT_TYPES=$EVENT_TYPES sbatch --partition=$PARTITION --nodes=$NODES --cpus-per-task=$CPUS_PER_TASK --job-name=train_${SREF_OR_HREF}_f${FORECAST_HOUR_START}-${FORECAST_HOUR_STOP}_${DATA_SUBSET_RATIO}_${NEAR_STORM_RATIO}_${EVENT_TYPES} /scratch/nadocast_dev/train_aws.sbatch
# 9 DATA_ROOT=$(pwd) PARTITION=spc-1 NODES=3 CPUS_PER_TASK=48 SREF_OR_HREF=href FORECAST_HOUR_START=24 FORECAST_HOUR_STOP=35 DATA_SUBSET_RATIO=0.03 NEAR_STORM_RATIO=0.4 EVENT_TYPES=sig_tornado,sig_wind; DATA_ROOT=$DATA_ROOT SREF_OR_HREF=$SREF_OR_HREF FORECAST_HOUR_START=$FORECAST_HOUR_START FORECAST_HOUR_STOP=$FORECAST_HOUR_STOP DATA_SUBSET_RATIO=$DATA_SUBSET_RATIO NEAR_STORM_RATIO=$NEAR_STORM_RATIO EVENT_TYPES=$EVENT_TYPES sbatch --partition=$PARTITION --nodes=$NODES --cpus-per-task=$CPUS_PER_TASK --job-name=train_${SREF_OR_HREF}_f${FORECAST_HOUR_START}-${FORECAST_HOUR_STOP}_${DATA_SUBSET_RATIO}_${NEAR_STORM_RATIO}_${EVENT_TYPES} /scratch/nadocast_dev/train_aws.sbatch
# 10 DATA_ROOT=$(pwd) PARTITION=spc-1 NODES=3 CPUS_PER_TASK=48 SREF_OR_HREF=href FORECAST_HOUR_START=24 FORECAST_HOUR_STOP=35 DATA_SUBSET_RATIO=0.03 NEAR_STORM_RATIO=0.4 EVENT_TYPES=tornado,wind; DATA_ROOT=$DATA_ROOT SREF_OR_HREF=$SREF_OR_HREF FORECAST_HOUR_START=$FORECAST_HOUR_START FORECAST_HOUR_STOP=$FORECAST_HOUR_STOP DATA_SUBSET_RATIO=$DATA_SUBSET_RATIO NEAR_STORM_RATIO=$NEAR_STORM_RATIO EVENT_TYPES=$EVENT_TYPES sbatch --partition=$PARTITION --nodes=$NODES --cpus-per-task=$CPUS_PER_TASK --job-name=train_${SREF_OR_HREF}_f${FORECAST_HOUR_START}-${FORECAST_HOUR_STOP}_${DATA_SUBSET_RATIO}_${NEAR_STORM_RATIO}_${EVENT_TYPES} /scratch/nadocast_dev/train_aws.sbatch
# 11 DATA_ROOT=$(pwd) PARTITION=spc-2 NODES=4 CPUS_PER_TASK=36 SREF_OR_HREF=href FORECAST_HOUR_START=24 FORECAST_HOUR_STOP=35 DATA_SUBSET_RATIO=0.03 NEAR_STORM_RATIO=0.4 EVENT_TYPES=sig_wind_adj; DATA_ROOT=$DATA_ROOT SREF_OR_HREF=$SREF_OR_HREF FORECAST_HOUR_START=$FORECAST_HOUR_START FORECAST_HOUR_STOP=$FORECAST_HOUR_STOP DATA_SUBSET_RATIO=$DATA_SUBSET_RATIO NEAR_STORM_RATIO=$NEAR_STORM_RATIO EVENT_TYPES=$EVENT_TYPES sbatch --partition=$PARTITION --nodes=$NODES --cpus-per-task=$CPUS_PER_TASK --job-name=train_${SREF_OR_HREF}_f${FORECAST_HOUR_START}-${FORECAST_HOUR_STOP}_${DATA_SUBSET_RATIO}_${NEAR_STORM_RATIO}_${EVENT_TYPES} /scratch/nadocast_dev/train_aws.sbatch
# 12 DATA_ROOT=$(pwd) PARTITION=spc-4 NODES=2 CPUS_PER_TASK=64 SREF_OR_HREF=href FORECAST_HOUR_START=24 FORECAST_HOUR_STOP=35 DATA_SUBSET_RATIO=0.03 NEAR_STORM_RATIO=0.4 EVENT_TYPES=sig_wind_adj; DATA_ROOT=$DATA_ROOT SREF_OR_HREF=$SREF_OR_HREF FORECAST_HOUR_START=$FORECAST_HOUR_START FORECAST_HOUR_STOP=$FORECAST_HOUR_STOP DATA_SUBSET_RATIO=$DATA_SUBSET_RATIO NEAR_STORM_RATIO=$NEAR_STORM_RATIO EVENT_TYPES=$EVENT_TYPES sbatch --partition=$PARTITION --nodes=$NODES --cpus-per-task=$CPUS_PER_TASK --job-name=train_${SREF_OR_HREF}_f${FORECAST_HOUR_START}-${FORECAST_HOUR_STOP}_${DATA_SUBSET_RATIO}_${NEAR_STORM_RATIO}_${EVENT_TYPES} /scratch/nadocast_dev/train_aws.sbatch


export HOME=/home/brian.hempel
export PATH=$PATH:$HOME/.local/bin:$HOME/bin

export FORECAST_HOUR_RANGE=${FORECAST_HOUR_START}:${FORECAST_HOUR_STOP}
export JULIA_MPI_BINARY=system
export JULIA_MPI_PATH=/opt/amazon/openmpi
export JULIA_MPI_LIBRARY=/opt/amazon/openmpi/lib64/libmpi
export JULIA_NUM_THREADS=$SLURM_CPUS_PER_TASK
export MUST_LOAD_FROM_DISK=true
export DISTRIBUTED=true

cd $DATA_ROOT

pwd

env

cat /proc/cpuinfo

time mpirun --bind-to none julia --compiled-modules=no --project=/scratch/nadocast_dev /scratch/nadocast_dev/models/${SREF_OR_HREF}_mid_2018_forward/TrainGradientBoostedDecisionTrees.jl
