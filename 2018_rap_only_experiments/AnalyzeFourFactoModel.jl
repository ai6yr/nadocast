# See what features are most significant to each factor of the four-factor model

# Factor 1 most relevant features
# Balanced (same number of tor/non-tor points)
# 0.11792413043568127  CRAIN:surface:storm path mean
# 0.10422888485181336  CRAIN:surface:storm path min
# 0.0953567077963597  CRAIN:surface:point
# 0.0740805722751752  HGT:lowest level of the wet bulb zero:storm path min
# -0.07012990536519088  HGT:convective cloud top level:storm path mean
# 0.06681566010166406  CRAIN:surface:storm path 50mi mean
# 0.06477832451238742  HLCY:1000-0 m above ground:point
# 0.06193857417234845  TGRD:angle radians from point storm motion 825 mb:storm path gradient
# 0.061563967642898204  TGRD:angle radians from point storm motion 875 mb:storm path gradient
# 0.06095720304685242  VVEL:125 mb:storm path 50mi mean
# 0.06026983076568776  HCDC:high cloud layer:storm path min
# -0.06001283688955713  RETOP:entire atmosphere (considered as a single layer):storm path min
# 0.0578586346373052  HLCY:1000-0 m above ground:storm path mean
# 0.05592285805669582  TGRD:angle radians from point storm motion 475 mb:storm path gradient
# 0.0558900713446209  TGRD:angle radians from point storm motion 450 mb:storm path gradient
# -0.054426542416964215  TGRD:angle radians from point storm motion 120-90 mb above ground:storm path min
# -0.05307040799525948  CRAIN:surface:storm path gradient
# 0.05018193353807769  TGRD:angle radians from point storm motion 850 mb:storm path gradient
# 0.049681155340759134  RH:400 mb:storm path gradient
# 0.049424322943931794  HLCY:1000-0 m above ground:storm path max
# Training data as-is
# 0.13165560556170317  CRAIN:surface:storm path mean
# 0.10695761495151887  CRAIN:surface:point
# 0.09042850440307244  CRAIN:surface:storm path min
# 0.07425412210620246  CRAIN:surface:storm path 50mi mean
# 0.0740063197864483  HGT:lowest level of the wet bulb zero:storm path min
# 0.06373109985462683  TGRD:angle radians from point storm motion 825 mb:storm path gradient
# 0.06321176382350903  TGRD:angle radians from point storm motion 875 mb:storm path gradient
# -0.06228346533656263  HGT:convective cloud top level:storm path mean
# 0.05981731228982731  HLCY:1000-0 m above ground:point
# -0.059388881104565874  CRAIN:surface:storm path gradient
# 0.05873308326706293  HCDC:high cloud layer:storm path min
# -0.058276657239733874  TGRD:angle radians from point storm motion 120-90 mb above ground:storm path min
# -0.057370319968066866  RETOP:entire atmosphere (considered as a single layer):storm path min
# 0.05725788290434451  VVEL:125 mb:storm path 50mi mean
# 0.05660682238952976  TGRD:angle radians from point storm motion 450 mb:storm path gradient
# 0.056549700006645005  TGRD:angle radians from point storm motion 475 mb:storm path gradient
# 0.0544705317282408  HLCY:1000-0 m above ground:storm path mean
# 0.05166173650034996  TGRD:angle radians from point storm motion 850 mb:storm path gradient
# 0.051400716359600175  TVCSH:angle radians from point storm motion 6000-0 m above ground:storm path gradient
# -0.05059365289130589  LFTX:500-1000 mb:point
# Factor 2 most relevant features
# Balanced (same number of tor/non-tor points)
# -0.10848857886273017  LFTX:500-1000 mb:point
# -0.10294764207239941  LFTX:500-1000 mb:storm path mean
# -0.08955816799886918  LFTX:500-1000 mb:storm path max
# -0.0867126136481714  LFTX:500-1000 mb:storm path 50mi mean
# 0.08576889744586967  CAPE:surface:storm path max
# 0.08565457973027728  HGT:convective cloud top level:storm path 50mi mean
# -0.08285085749594015  LFTX:500-1000 mb:storm path min
# 0.08069465974564528  TSTM:angle radians from point storm motion storm motion:storm path gradient
# 0.07376700328233128  HGT:convective cloud top level:storm path mean
# 0.0682240730246926  TGRD:angle radians from point storm motion max wind:storm path gradient
# 0.06390117390715672  CAPE:90-0 mb above ground:storm path max
# -0.0605203048609983  CRAIN:surface:storm path gradient
# 0.053400479749000675  CAPE:surface:point
# 0.04982140450004594  LTNG:surface:storm path 50mi mean
# -0.04841545745160105  TGRD:angle radians from point storm motion 325 mb:storm path gradient
# 0.04781256461627314  CAPE:surface:storm path 50mi mean
# -0.04718685418932993  MSTAV:0 m underground:storm path gradient
# -0.04669635439356844  CRAIN:surface:storm path min
# 0.04631195914564246  HGT:convective cloud top level:point
# 0.04461005769566685  CAPE:90-0 mb above ground:point
# Training data as-is
# -0.12608941147013678  LFTX:500-1000 mb:point
# -0.12010573817197569  LFTX:500-1000 mb:storm path mean
# -0.1025777174259487  LFTX:500-1000 mb:storm path max
# -0.10136860402144292  LFTX:500-1000 mb:storm path 50mi mean
# -0.09569245182293225  LFTX:500-1000 mb:storm path min
# 0.08448039742950249  CAPE:surface:storm path max
# 0.08081079314207323  TSTM:angle radians from point storm motion storm motion:storm path gradient
# 0.07831107977603356  HGT:convective cloud top level:storm path 50mi mean
# 0.07031462798706352  TGRD:angle radians from point storm motion max wind:storm path gradient
# -0.06772575010395555  CRAIN:surface:storm path gradient
# 0.06551362885764926  HGT:convective cloud top level:storm path mean
# 0.06227241984887607  CAPE:90-0 mb above ground:storm path max
# 0.05202571309958865  CAPE:surface:point
# -0.049675476224122404  TGRD:angle radians from point storm motion 325 mb:storm path gradient
# 0.047549423151608136  CAPE:surface:storm path 50mi mean
# 0.046676954042656  LTNG:surface:storm path 50mi mean
# -0.04595458685040056  CSNOW:surface:point
# -0.04573603968027262  MSTAV:0 m underground:storm path gradient
# 0.04487907975517325  CRAIN:surface:point
# 0.044511094970512574  CRAIN:surface:storm path mean
# Factor 3 most relevant features
# Balanced (same number of tor/non-tor points)
# -0.09980431543410907  HGT:lowest level of the wet bulb zero:storm path min
# 0.06503154863465993  CRAIN:surface:storm path mean
# 0.06298056577428927  CRAIN:surface:point
# -0.06217324448352115  TGRD:angle radians from point storm motion 450 mb:storm path gradient
# -0.05830729776811587  LFTX:500-1000 mb:storm path min
# -0.055640431344063615  HGT:lowest level of the wet bulb zero:storm path 50mi mean
# -0.05483497549030127  MSTAV:0 m underground:storm path gradient
# -0.05482795347530703  LFTX:500-1000 mb:point
# 0.05465518251818513  TGRD:angle radians from point storm motion 250 mb:storm path gradient
# 0.05402162527746172  TGRD:angle radians from point storm motion 975 mb:storm path min
# -0.05300420871738494  TGRD:angle radians from point storm motion 650 mb:storm path gradient
# -0.052424127048336704  LFTX:500-1000 mb:storm path mean
# -0.046809898499723945  VVEL:950 mb:storm path 50mi mean
# 0.04622208069744191  REFD:4000 m above ground:point
# -0.04597053933574379  CRAIN:surface:storm path gradient
# -0.04585851548426755  VVEL:900 mb:storm path 50mi mean
# 0.045368080995788214  HLCY:1000-0 m above ground:storm path mean
# -0.044589458523261336  TGRD:angle radians from point storm motion 100 mb:storm path gradient
# -0.044366674848303485  RETOP:entire atmosphere (considered as a single layer):storm path min
# 0.044284018115722634  CRAIN:surface:storm path 50mi mean
# Training data as-is
# -0.09970427950594239  HGT:lowest level of the wet bulb zero:storm path min
# 0.07260403688777933  CRAIN:surface:storm path mean
# 0.0706426559723615  CRAIN:surface:point
# -0.06734472582705861  LFTX:500-1000 mb:storm path min
# -0.06372306152669543  LFTX:500-1000 mb:point
# -0.06297057282604843  TGRD:angle radians from point storm motion 450 mb:storm path gradient
# -0.061161560871242256  LFTX:500-1000 mb:storm path mean
# 0.056365724705607266  TGRD:angle radians from point storm motion 250 mb:storm path gradient
# 0.054661804042341874  TGRD:angle radians from point storm motion 975 mb:storm path min
# -0.053265188492609174  TGRD:angle radians from point storm motion 650 mb:storm path gradient
# -0.05319232084482898  HGT:lowest level of the wet bulb zero:storm path 50mi mean
# -0.05314901062970838  MSTAV:0 m underground:storm path gradient
# -0.0514437140782322  CRAIN:surface:storm path gradient
# 0.04921407471713738  CRAIN:surface:storm path 50mi mean
# 0.0463407733627292  CRAIN:surface:storm path max
# -0.04535820795997197  LFTX:500-1000 mb:storm path 50mi mean
# -0.04393862632109175  TGRD:angle radians from point storm motion 425 mb:storm path gradient
# -0.04317140006618321  TGRD:angle radians from point storm motion 475 mb:storm path gradient
# -0.04287989960596171  TGRD:angle radians from point storm motion 100 mb:storm path gradient
# -0.042817182158672265  CSNOW:surface:point
# Factor 4 most relevant features
# Balanced (same number of tor/non-tor points)
# 0.08735211623302569  CRAIN:surface:storm path mean
# -0.059296158430369665  RETOP:entire atmosphere (considered as a single layer):storm path min
# -0.05892578102065526  LFTX:500-1000 mb:point
# 0.05799129098574283  CRAIN:surface:point
# -0.054711101086411335  TGRD:angle radians from point storm motion 125 mb:storm path gradient
# -0.05221243248247265  LFTX:500-1000 mb:storm path mean
# 0.04718440341510809  HGT:convective cloud top level:storm path mean
# -0.046534631808554834  TGRD:angle radians from point storm motion 925 mb:point
# -0.045998763611379063  TGRD:angle radians from point storm motion 120-90 mb above ground:storm path gradient
# 0.044478757644742614  HLCY:1000-0 m above ground:storm path min
# -0.04406656782903949  TGRD:angle radians from point storm motion 875 mb:storm path gradient
# -0.041445823308087784  LFTX:500-1000 mb:storm path min
# 0.03949737486615518  HGT:convective cloud top level:storm path 50mi mean
# -0.03809118541854562  TGRD:angle radians from point storm motion 500 mb:storm path gradient
# 0.03730612959317719  REFD:4000 m above ground:storm path 50mi mean
# 0.036897269084807754  REFD:4000 m above ground:storm path mean
# 0.03689048372551828  HGT:surface:storm path min
# -0.03654383936246702  LFTX:500-1000 mb:storm path max
# 0.036125501880587406  ABSV:500 mb:storm path gradient
# 0.03600005481172157  RH:125 mb:storm path max
# Training data as-is
# 0.0975236850784147  CRAIN:surface:storm path mean
# -0.06848570722558361  LFTX:500-1000 mb:point
# 0.0650463959498333  CRAIN:surface:point
# -0.06091458355745184  LFTX:500-1000 mb:storm path mean
# -0.05668519867321003  RETOP:entire atmosphere (considered as a single layer):storm path min
# -0.05295155509812049  TGRD:angle radians from point storm motion 125 mb:storm path gradient
# -0.049699918243592565  TGRD:angle radians from point storm motion 925 mb:point
# -0.047869781557364044  LFTX:500-1000 mb:storm path min
# -0.04689762210948958  TGRD:angle radians from point storm motion 120-90 mb above ground:storm path gradient
# -0.04524603570515997  TGRD:angle radians from point storm motion 875 mb:storm path gradient
# 0.0437928780930697  HLCY:1000-0 m above ground:storm path min
# -0.04277769340077224  CSNOW:surface:storm path mean
# 0.0419052063342717  HGT:convective cloud top level:storm path mean
# -0.04185641255892747  LFTX:500-1000 mb:storm path max
# 0.04094749536853059  LTNG:surface:storm path max
# -0.04069451947861655  LFTX:500-1000 mb:storm path 50mi mean
# 0.03951214504274965  HGT:surface:storm path min
# -0.03948433891671486  CSNOW:surface:point
# -0.03846296633871848  TGRD:angle radians from point storm motion 500 mb:storm path gradient
# 0.037543113160684816  CRAIN:surface:storm path max

import StatsBase

if length(ARGS) < 2
  error("Must provide a model script and a saved model file")
end

model_dir_and_type = ARGS[1]
saved_model_path   = ARGS[2]

model_dir    = dirname(model_dir_and_type)
model_script = basename(model_dir_and_type)
# model_type   = replace(model_script, ".jl", "")


train_file_path    = "$model_dir/train-shuffled.binfeatures"
train_labels_path  = "$model_dir/train-shuffled.binlabels"
train_weights_path = "$model_dir/train-shuffled.binweights"

include("ReadFeatureData.jl")

feature_normalizers = include("NormalizingFactors.jl")


train_data, train_data_file, train_point_count = open_data_file(train_file_path)

train_labels  = read(train_labels_path, Float32, train_point_count)
train_weights = read(train_weights_path, Float32, train_point_count)

println("$train_point_count training points.")

println("Loading tornado points")
tornado_points     = train_data[:, 1.0f0 .== train_labels]
println("Loading non-tornado points")
non_tornado_points = train_data[:, find(0.0f0 .== train_labels)[1:size(tornado_points, 2)]]

tornado_weights     = train_weights[1.0f0 .== train_labels]
non_tornado_weights = train_weights[find(0.0f0 .== train_labels)[1:size(tornado_points, 2)]]


balanced_points  = hcat(tornado_points, non_tornado_points)
balanced_weights = vcat(tornado_weights, non_tornado_weights)

println("Loading various points")
various_points  = train_data[:, 1:(size(tornado_points, 2)*2)]
various_weights = train_weights[1:(size(tornado_points, 2)*2)]



stdout_limited = IOContext(STDOUT, :display_size=>(100,60))
stdout_limited = IOContext(stdout_limited, :limit=>true)

# show(stdout_limited, "text/plain", balanced_std_devs)
# println("")


balanced_std_devs = StatsBase.std(balanced_points, StatsBase.ProbabilityWeights(balanced_weights), 2; corrected=true)[:]
various_std_devs  = StatsBase.std(various_points,  StatsBase.ProbabilityWeights(various_weights),  2; corrected=true)[:]

include("$model_dir/$model_script")

println("Loading $saved_model_path...")

model_load(saved_model_path)

function print_factor_most_import_features(factor)
  balanced_importance = Flux.Tracker.data(factor.W)[1,:] .* (balanced_std_devs ./ feature_normalizers)
  various_importance  = Flux.Tracker.data(factor.W)[1,:] .* (various_std_devs  ./ feature_normalizers)
  balanced_most_important = reverse(sortperm(abs.(balanced_importance)))
  various_most_important  = reverse(sortperm(abs.(various_importance)))

  println("Balanced (same number of tor/non-tor points)")
  for i = 1:20
    j = balanced_most_important[i]
    println("$(balanced_importance[j])\t$(FEATURE_HEADERS[j])")
  end

  println("Training data as-is")
  for i = 1:20
    j = various_most_important[i]
    println("$(various_importance[j])\t$(FEATURE_HEADERS[j])")
  end
end

println("Factor 1 most relevant features")
print_factor_most_import_features(model.f1)

println("Factor 2 most relevant features")
print_factor_most_import_features(model.f2)

println("Factor 3 most relevant features")
print_factor_most_import_features(model.f3)

println("Factor 4 most relevant features")
print_factor_most_import_features(model.f4)


close(train_data_file)
